steps:
  - name: api-build-and-deploy-staging
    command:
      - |
        npm i -g --unsafe-perm now
        cd api 
        cp src/data/config.template.json src/data/config.staging.json
        jq -r '.provider = $provider' --arg provider $IRI_NODE src/data/config.template.json > src/data/config.staging.json
        jq -r '.dynamoDbConnection .accessKeyId = $accessKeyId' --arg accessKeyId $CERT_AWS_ACCESS_KEY_ID src/data/config.staging.json > tmp.$$.json && mv tmp.$$.json src/data/config.staging.json
        jq -r '.dynamoDbConnection .secretKeyId = $secretKeyId' --arg secretKeyId $CERT_AWS_SECRET_ACCESS_KEY src/data/config.staging.json > tmp.$$.json && mv tmp.$$.json src/data/config.staging.json
        jq -r '.dynamoDbConnection .dbTablePrefix = $dbTablePrefix' --arg dbTablePrefix $DB_TABLE_PREFIX src/data/config.staging.json > tmp.$$.json && mv tmp.$$.json src/data/config.staging.json
        jq -r '.s3Connection .bucketPrefix = $bucketPrefix' --arg bucketPrefix $BUCKET_PREFIX src/data/config.staging.json > tmp.$$.json && mv tmp.$$.json src/data/config.staging.json
        jq -r '.mainBucket = $mainBucket' --arg mainBucket $MAIN_BUCKET src/data/config.staging.json > tmp.$$.json && mv tmp.$$.json src/data/config.staging.json
        jq -r '.version = $version' --arg version '2' now.json > tmp.$$.json && mv tmp.$$.json now.json
        jq -r '.name = $name' --arg name 'certification-api' now.json > tmp.$$.json && mv tmp.$$.json now.json
        jq -r '.alias = $alias' --arg alias $ALIAS now.json > tmp.$$.json && mv tmp.$$.json now.json
        now --token $ZEIT_TOKEN --team iota deploy -e CONFIG_ID=staging -m BK_JOB_ID=$BUILDKITE_JOB_ID

    plugins:
       https://github.com/iotaledger/docker-buildkite-plugin#release-v2.0.0:
         image: "node:8.12-stretch"
         environment:
          - IRI_NODE
          - CERT_AWS_ACCESS_KEY_ID
          - CERT_AWS_SECRET_ACCESS_KEY
          - DB_TABLE_PREFIX=certification-api-staging-
          - BUCKET_PREFIX=certification-staging-
          - MAIN_BUCKET=main
          - ALIAS=certification-api.iota.works
          - ZEIT_TOKEN
#          - CONFIG_ID=staging

    agents:
      queue: aws-nano