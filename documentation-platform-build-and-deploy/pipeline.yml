steps:
  - name: api-build-and-deploy-staging
    command:
      - |
        rm -rf ci-pipelines
        npm i -g --unsafe-perm now
        cp ci-pipelines/$BUILDKITE_PIPELINE_SLUG/api/src/data/config.staging.json api/src/data/config.json
        cp ci-pipelines/$BUILDKITE_PIPELINE_SLUG/api/now.staging.json api/now.json
        sed -i.bak s#DOCS-STAGING-AWS-ACCESS-KEY-ID#\$DOCS_STAGING_AWS_ACCESS_KEY_ID#g api/src/data/config.json
        sed -i.bak s#DOCS-STAGING-AWS-SECRET-ACCESS-KEY#\$DOCS_STAGING_AWS_SECRET_ACCESS_KEY#g api/src/data/config.json
        cd api
        now --platform-version 1 --token \$ZEIT_TOKEN --team iota deploy --force --docker -n documentation-api -m BK_JOB_ID=$BUILDKITE_JOB_ID
        NOW_SH_DEPLOYMENT_ID=$(now --platform-version 1 --token \$ZEIT_TOKEN --team iota ls -m BK_JOB_ID=$BUILDKITE_JOB_ID | grep documentation-api | awk {'print \$2'})
        now --platform-version 1 --token \$ZEIT_TOKEN --team iota alias \$NOW_SH_DEPLOYMENT_ID docs-api.iota.works
    plugins:
       https://github.com/iotaledger/docker-buildkite-plugin#release-v2.0.0:
         image: "node:8.12-stretch"
         environment:
          - ZEIT_TOKEN
    agents:
      queue: ops

  - name: web-build-and-deploy-staging
    command:
      - |
        rm -rf ci-pipelines
        rm -rf docs && mkdir -p docs
        buildkite-agent artifact download ./ docs/ --build $DOCS_MARKDOWN_BUILDKITE_BUILD_ID
        npm i -g --unsafe-perm now
        cp ci-pipelines/$BUILDKITE_PIPELINE_SLUG/web/src/config.staging.json src/config.json
        cp ci-pipelines/$BUILDKITE_PIPELINE_SLUG/web/now.staging.json now.json
        sed -i.bak s#DOCS-PROD-AWS-ACCESS-KEY-ID#\$DOCS_PROD_AWS_ACCESS_KEY_ID#g api/src/data/config.json
        sed -i.bak s#DOCS-PROD-AWS-SECRET-ACCESS-KEY#\$DOCS_PROD_AWS_SECRET_ACCESS_KEY#g api/src/data/config.json
        now --platform-version 1 --token \$ZEIT_TOKEN --team iota deploy --force --docker -n documentation-web -m BK_JOB_ID=$BUILDKITE_JOB_ID
        NOW_SH_DEPLOYMENT_ID=$(now --platform-version 1 --token \$ZEIT_TOKEN --team iota ls -m BK_JOB_ID=$BUILDKITE_JOB_ID | grep documentation-web | awk {'print \$2'})
        now --platform-version 1 --token \$ZEIT_TOKEN --team iota alias \$NOW_SH_DEPLOYMENT_ID docs.iota.works
    plugins:
       https://github.com/iotaledger/docker-buildkite-plugin#release-v2.0.0:
         image: "node:8.12-stretch"
         mount-buildkite-agent: true
         environment:
          - ZEIT_TOKEN
          - DOCS_MARKDOWN_BUILDKITE_BUILD_ID
    agents:
      queue: ops

  - block: "Deploy LIVE"
    prompt: "Deploy this build to docs.iota.org and docs-api.iota.org?"

  - name: api-build-and-deploy-prod
    command:
      - |
        rm -rf ci-pipelines
        npm i -g --unsafe-perm now
        cp ci-pipelines/$BUILDKITE_PIPELINE_SLUG/api/src/data/config.prod.json api/src/data/config.json
        cp ci-pipelines/$BUILDKITE_PIPELINE_SLUG/api/now.prod.json api/now.json
        cd api
        now --platform-version 1 --token \$ZEIT_TOKEN --team iota deploy --force --docker -n documentation-api -m BK_JOB_ID=$BUILDKITE_JOB_ID
        NOW_SH_DEPLOYMENT_ID=$(now --platform-version 1 --token \$ZEIT_TOKEN --team iota ls -m BK_JOB_ID=$BUILDKITE_JOB_ID | grep documentation-api | awk {'print \$2'})
        now --platform-version 1 --token \$ZEIT_TOKEN --team iota alias \$NOW_SH_DEPLOYMENT_ID docs-api.iota.org
    plugins:
       https://github.com/iotaledger/docker-buildkite-plugin#release-v2.0.0:
         image: "node:8.12-stretch"
         environment:
          - ZEIT_TOKEN
    agents:
      queue: ops

  - name: web-build-and-deploy-prod
    command:
      - |
        rm -rf ci-pipelines
        rm -rf docs && mkdir -p docs
        buildkite-agent artifact download ./ docs/ --build $DOCS_MARKDOWN_BUILDKITE_BUILD_ID
        npm i -g --unsafe-perm now
        cp ci-pipelines/$BUILDKITE_PIPELINE_SLUG/web/src/config.prod.json src/config.json
        cp ci-pipelines/$BUILDKITE_PIPELINE_SLUG/web/now.prod.json now.json
        now --platform-version 1 --token \$ZEIT_TOKEN --team iota deploy --force --docker -n documentation-web -m BK_JOB_ID=$BUILDKITE_JOB_ID
        NOW_SH_DEPLOYMENT_ID=$(now --platform-version 1 --token \$ZEIT_TOKEN --team iota ls -m BK_JOB_ID=$BUILDKITE_JOB_ID | grep documentation-web | awk {'print \$2'})
        now --platform-version 1 --token \$ZEIT_TOKEN --team iota alias \$NOW_SH_DEPLOYMENT_ID docs.iota.org
    plugins:
       https://github.com/iotaledger/docker-buildkite-plugin#release-v2.0.0:
         image: "node:8.12-stretch"
         mount-buildkite-agent: true
         environment:
          - ZEIT_TOKEN
          - DOCS_MARKDOWN_BUILDKITE_BUILD_ID
    agents:
      queue: ops
